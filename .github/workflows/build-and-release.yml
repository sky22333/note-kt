name: Build and Release Android App

# è§¦å‘æ¡ä»¶ï¼šå½“æŽ¨é€æ–°çš„tagæ—¶è§¦å‘
on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v2.1.0 ç­‰æ ¼å¼çš„tag

jobs:
  build-and-release:
    name: Build Debug APK and Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´çš„gitåŽ†å²
    
    # 2. è®¾ç½®JDKçŽ¯å¢ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    # 3. è®¾ç½®Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    # 4. ç”ŸæˆGradle Wrapperæ–‡ä»¶
    - name: Generate Gradle Wrapper
      run: |
        echo "ðŸ“¦ æ£€æŸ¥Gradle Wrapperæ–‡ä»¶..."
        
        # æ£€æŸ¥gradle-wrapper.jaræ˜¯å¦å­˜åœ¨
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "â¬‡ï¸ ä¸‹è½½gradle-wrapper.jar..."
          curl -L -o gradle/wrapper/gradle-wrapper.jar \
            "https://github.com/gradle/gradle/raw/v8.2.0/gradle/wrapper/gradle-wrapper.jar"
          echo "âœ… gradle-wrapper.jarä¸‹è½½å®Œæˆ"
        else
          echo "âœ… gradle-wrapper.jarå·²å­˜åœ¨"
        fi
        
        # æ£€æŸ¥gradlewè„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "gradlew" ]; then
          echo "â¬‡ï¸ ä¸‹è½½gradlewè„šæœ¬..."
          curl -L -o gradlew \
            "https://github.com/gradle/gradle/raw/v8.2.0/gradlew"
          echo "âœ… gradlewè„šæœ¬ä¸‹è½½å®Œæˆ"
        else
          echo "âœ… gradlewè„šæœ¬å·²å­˜åœ¨"
        fi
        
        # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        echo "ðŸ” éªŒè¯Gradle Wrapperæ–‡ä»¶..."
        ls -la gradle/wrapper/gradle-wrapper.jar
        ls -la gradlew
        
    
    # 5. èµ‹äºˆgradlewæ‰§è¡Œæƒé™
    - name: Grant execute permission for gradlew
      run: |
        chmod +x gradlew
        echo "âœ… gradlewæ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"
        
        # éªŒè¯gradlewå¯æ‰§è¡Œ
        echo "ðŸ” éªŒè¯Gradle Wrapper..."
        ./gradlew --version
    
    # 6. ç¼“å­˜Gradleä¾èµ–
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    # 7. æž„å»ºDebug APK
    - name: Build Debug APK
      run: ./gradlew assembleDebug --stacktrace
    
    # 8. ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 30
    
    # 9. èŽ·å–APKæ–‡ä»¶ä¿¡æ¯
    - name: Get APK info
      id: apk_info
      run: |
        APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
        APK_NAME=$(basename "$APK_PATH")
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
        echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
    
    # 10. ç”Ÿæˆç‰ˆæœ¬è¯´æ˜Ž
    - name: Generate release notes
      id: release_notes
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        
        # èŽ·å–ä¸Šä¸€ä¸ªtag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        # ç”Ÿæˆæ›´æ–°æ—¥å¿—
        if [ -n "$PREVIOUS_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD)
        else
          CHANGELOG=$(git log --pretty=format:"- %s" --max-count=10)
        fi
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
        cat > release_notes.md << EOF
        ## ðŸš€ çŽ°ä»£ç¬”è®° $TAG_NAME
        
        ### ðŸ“± åº”ç”¨ä¿¡æ¯
        - **ç‰ˆæœ¬**: $TAG_NAME
        - **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - **APKå¤§å°**: ${{ steps.apk_info.outputs.apk_size }}
        - **æœ€ä½ŽAndroidç‰ˆæœ¬**: 7.0 (API 24)
        - **ç›®æ ‡Androidç‰ˆæœ¬**: 14 (API 34)
        
        ### ðŸ“‹ æ›´æ–°å†…å®¹
        $CHANGELOG
        
        ### ðŸ”§ æŠ€æœ¯æ ˆ
        - Kotlin + Jetpack Compose
        - Material Design 3
        - Room + SQLite
        - MVVM + Repository æž¶æž„
        - Hilt ä¾èµ–æ³¨å…¥
        
        ### ðŸ“¥ å®‰è£…è¯´æ˜Ž
        1. ä¸‹è½½ä¸‹æ–¹çš„ APK æ–‡ä»¶
        2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
        3. å®‰è£…å¹¶äº«å—çŽ°ä»£åŒ–çš„ç¬”è®°ä½“éªŒ
        
        ### ðŸ› é—®é¢˜åé¦ˆ
        å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) ä¸­åé¦ˆã€‚
        EOF
    
    # 11. åˆ›å»ºGitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.release_notes.outputs.tag_name }}
        name: çŽ°ä»£ç¬”è®° ${{ steps.release_notes.outputs.tag_name }}
        body_path: release_notes.md
        files: ${{ steps.apk_info.outputs.apk_path }}
        draft: false
        prerelease: false
        make_latest: true
      env:

        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
