name: Manual Build

# æ‰‹åŠ¨è§¦å‘æž„å»º
on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release
      create_release:
        description: 'æ˜¯å¦åˆ›å»ºRelease'
        required: false
        default: false
        type: boolean
      release_tag:
        description: 'Releaseæ ‡ç­¾ (å¦‚æžœåˆ›å»ºRelease)'
        required: false
        default: ''
        type: string

jobs:
  manual-build:
    name: Manual Build APK
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    # æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v4
    
    # è®¾ç½®JDKçŽ¯å¢ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
    
    # è®¾ç½®Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    # ç”ŸæˆGradle Wrapperæ–‡ä»¶
    - name: Generate Gradle Wrapper
      run: |
        echo "ðŸ“¦ æ£€æŸ¥Gradle Wrapperæ–‡ä»¶..."
        
        # æ£€æŸ¥gradle-wrapper.jaræ˜¯å¦å­˜åœ¨
        if [ ! -f "gradle/wrapper/gradle-wrapper.jar" ]; then
          echo "â¬‡ï¸ ä¸‹è½½gradle-wrapper.jar..."
          curl -L -o gradle/wrapper/gradle-wrapper.jar \
            "https://github.com/gradle/gradle/raw/v8.2.0/gradle/wrapper/gradle-wrapper.jar"
          echo "âœ… gradle-wrapper.jarä¸‹è½½å®Œæˆ"
        else
          echo "âœ… gradle-wrapper.jarå·²å­˜åœ¨"
        fi
        
        # æ£€æŸ¥gradlewè„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "gradlew" ]; then
          echo "â¬‡ï¸ ä¸‹è½½gradlewè„šæœ¬..."
          curl -L -o gradlew \
            "https://github.com/gradle/gradle/raw/v8.2.0/gradlew"
          echo "âœ… gradlewè„šæœ¬ä¸‹è½½å®Œæˆ"
        else
          echo "âœ… gradlewè„šæœ¬å·²å­˜åœ¨"
        fi
        
        # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        echo "ðŸ” éªŒè¯Gradle Wrapperæ–‡ä»¶..."
        ls -la gradle/wrapper/gradle-wrapper.jar
        ls -la gradlew
        
    
    # èµ‹äºˆgradlewæ‰§è¡Œæƒé™
    - name: Grant execute permission for gradlew
      run: |
        chmod +x gradlew
        echo "âœ… gradlewæ‰§è¡Œæƒé™è®¾ç½®å®Œæˆ"
        
        # éªŒè¯gradlewå¯æ‰§è¡Œ
        echo "ðŸ” éªŒè¯Gradle Wrapper..."
        ./gradlew --version
    
    # ç¼“å­˜Gradleä¾èµ–
    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
    
    # æž„å»ºAPK
    - name: Build APK
      run: |
        if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
          echo "æž„å»ºReleaseç‰ˆæœ¬..."
          ./gradlew assembleRelease
        else
          echo "æž„å»ºDebugç‰ˆæœ¬..."
          ./gradlew assembleDebug
        fi
    
    # èŽ·å–APKä¿¡æ¯
    - name: Get APK info
      id: apk_info
      run: |
        if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          BUILD_TYPE="release"
        else
          APK_PATH=$(find app/build/outputs/apk/debug -name "*.apk" | head -1)
          BUILD_TYPE="debug"
        fi
        
        APK_NAME=$(basename "$APK_PATH")
        APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
        
        echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
        echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
        echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
    
    # ä¸Šä¼ APKæ–‡ä»¶
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.apk_info.outputs.build_type }}-apk-${{ github.run_number }}
        path: ${{ steps.apk_info.outputs.apk_path }}
        retention-days: 7
    
    # åˆ›å»ºRelease (å¦‚æžœé€‰æ‹©)
    - name: Create Release
      if: ${{ github.event.inputs.create_release == 'true' }}
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event.inputs.release_tag || format('manual-{0}', github.run_number) }}
        name: çŽ°ä»£ç¬”è®° ${{ github.event.inputs.release_tag || format('manual-{0}', github.run_number) }}
        body: |
          ### ðŸ“± æž„å»ºä¿¡æ¯
          - **æž„å»ºç±»åž‹**: ${{ github.event.inputs.build_type }}
          - **æž„å»ºæ—¶é—´**: ${{ steps.date.outputs.date }}
          - **APKå¤§å°**: ${{ steps.apk_info.outputs.apk_size }}
          - **æž„å»ºç¼–å·**: #${{ github.run_number }}
          
          > æ‰‹åŠ¨æž„å»ºç‰ˆæœ¬ã€‚
        files: ${{ steps.apk_info.outputs.apk_path }}
        draft: false
        prerelease: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
